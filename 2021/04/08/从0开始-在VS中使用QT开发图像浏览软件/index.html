<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/blog/03_16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog/03_32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog/03_16x16.png">
  <link rel="mask-icon" href="/images/blog/03_16x16.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"whuls.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="由于OpenCV的MSVC版本在预览图像时的不便捷性，而QT Creator调试又过于恶心，因此希望基于VS和QT开发一个图像预览的软件，附带一些处理功能。文章记录了从安装到开发的全过程，使用VS2019和QT5.12.9。">
<meta property="og:type" content="article">
<meta property="og:title" content="从0开始：在VS中使用QT开发图像浏览软件">
<meta property="og:url" content="https://whuls.github.io/2021/04/08/%E4%BB%8E0%E5%BC%80%E5%A7%8B-%E5%9C%A8VS%E4%B8%AD%E4%BD%BF%E7%94%A8QT%E5%BC%80%E5%8F%91%E5%9B%BE%E5%83%8F%E6%B5%8F%E8%A7%88%E8%BD%AF%E4%BB%B6/index.html">
<meta property="og:site_name" content="林杉的个人博客">
<meta property="og:description" content="由于OpenCV的MSVC版本在预览图像时的不便捷性，而QT Creator调试又过于恶心，因此希望基于VS和QT开发一个图像预览的软件，附带一些处理功能。文章记录了从安装到开发的全过程，使用VS2019和QT5.12.9。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://whuls.github.io/images/KvImage-v1.0.gif">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404175740602.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210327164249008.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210327222045440.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210327222129162.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404201139344.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404211148671.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404211941464.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404223952398.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404201222288.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404201641592.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404201734798.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210404202311477.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210405180352839.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210405180434022.png">
<meta property="og:image" content="https://whuls.github.io/images/image-20210405190551306.png">
<meta property="article:published_time" content="2021-04-08T15:11:37.000Z">
<meta property="article:modified_time" content="2021-04-12T14:18:37.437Z">
<meta property="article:author" content="林杉">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="Qt">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://whuls.github.io/images/KvImage-v1.0.gif">

<link rel="canonical" href="https://whuls.github.io/2021/04/08/%E4%BB%8E0%E5%BC%80%E5%A7%8B-%E5%9C%A8VS%E4%B8%AD%E4%BD%BF%E7%94%A8QT%E5%BC%80%E5%8F%91%E5%9B%BE%E5%83%8F%E6%B5%8F%E8%A7%88%E8%BD%AF%E4%BB%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>从0开始：在VS中使用QT开发图像浏览软件 | 林杉的个人博客</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5ef394f44970187e7ab7e57f9ffe9a4e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
    <a href="https://github.com/whuls" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">林杉的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">66</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">24</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">68</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://whuls.github.io/2021/04/08/%E4%BB%8E0%E5%BC%80%E5%A7%8B-%E5%9C%A8VS%E4%B8%AD%E4%BD%BF%E7%94%A8QT%E5%BC%80%E5%8F%91%E5%9B%BE%E5%83%8F%E6%B5%8F%E8%A7%88%E8%BD%AF%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/blog/avatar_136x136.png">
      <meta itemprop="name" content="林杉">
      <meta itemprop="description" content="开发记录 & 思考笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林杉的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          从0开始：在VS中使用QT开发图像浏览软件
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-08 23:11:37" itemprop="dateCreated datePublished" datetime="2021-04-08T23:11:37+08:00">2021-04-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-12 22:18:37" itemprop="dateModified" datetime="2021-04-12T22:18:37+08:00">2021-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ol class="post-body-toc"><li class="post-body-toc-item post-body-toc-level-1"><a class="post-body-toc-link" href="#安装"><span class="post-body-toc-text">安装</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#Qt的安装"><span class="post-body-toc-text">Qt的安装</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#VS插件的安装"><span class="post-body-toc-text">VS插件的安装</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#Hello-World"><span class="post-body-toc-text">Hello World</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#问题1-没有与指定类型匹配的重载函数"><span class="post-body-toc-text">问题1 没有与指定类型匹配的重载函数</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#问题2-ERROR-running-qmake"><span class="post-body-toc-text">问题2 ERROR running qmake</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#彻底解决问题1与问题2"><span class="post-body-toc-text">彻底解决问题1与问题2</span></a></li></ol></li></ol></li><li class="post-body-toc-item post-body-toc-level-1"><a class="post-body-toc-link" href="#添加基础功能示例：打开一幅图像"><span class="post-body-toc-text">添加基础功能示例：打开一幅图像</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#布局"><span class="post-body-toc-text">布局</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#打开图像文件对话框"><span class="post-body-toc-text">打开图像文件对话框</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#使用OpenCV读取图像"><span class="post-body-toc-text">使用OpenCV读取图像</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#OpenCV与QImage和QPixmap的相互转化"><span class="post-body-toc-text">OpenCV与QImage和QPixmap的相互转化</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#在QLabel中显示图像QPixmap"><span class="post-body-toc-text">在QLabel中显示图像QPixmap</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#基本设置方法"><span class="post-body-toc-text">基本设置方法</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#指定显示区域尺寸的位图"><span class="post-body-toc-text">指定显示区域尺寸的位图</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#★★★同时指定显示区域尺寸和图像矩形的位图"><span class="post-body-toc-text">★★★同时指定显示区域尺寸和图像矩形的位图</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#showImage图像显示接口函数"><span class="post-body-toc-text">showImage图像显示接口函数</span></a></li></ol></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#打开图像的响应函数"><span class="post-body-toc-text">打开图像的响应函数</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#QLabel的大小及图像自适应"><span class="post-body-toc-text">QLabel的大小及图像自适应</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#图像缩放和拖动"><span class="post-body-toc-text">图像缩放和拖动</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#图像矩形的概念"><span class="post-body-toc-text">图像矩形的概念</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#加入图像矩形后的程序优化"><span class="post-body-toc-text">加入图像矩形后的程序优化</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#拖动图像"><span class="post-body-toc-text">拖动图像</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#缩放图像"><span class="post-body-toc-text">缩放图像</span></a></li></ol></li></ol></li><li class="post-body-toc-item post-body-toc-level-1"><a class="post-body-toc-link" href="#添加文件输出日志"><span class="post-body-toc-text">添加文件输出日志</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#完整代码"><span class="post-body-toc-text">完整代码</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#解决重写消息控制后无法输出到控制台的问题"><span class="post-body-toc-text">解决重写消息控制后无法输出到控制台的问题</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#输出到控制台的函数：OutputDebugString"><span class="post-body-toc-text">输出到控制台的函数：OutputDebugString</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#直接输出字符串到控制台"><span class="post-body-toc-text">直接输出字符串到控制台</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#将const-char-输出到控制台"><span class="post-body-toc-text">将const char *输出到控制台</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#将std-string输出到控制台"><span class="post-body-toc-text">将std::string输出到控制台</span></a></li><li class="post-body-toc-item post-body-toc-level-3"><a class="post-body-toc-link" href="#将QString的结果输出到控制台"><span class="post-body-toc-text">将QString的结果输出到控制台</span></a></li></ol></li></ol></li><li class="post-body-toc-item post-body-toc-level-1"><a class="post-body-toc-link" href="#避免中文乱码"><span class="post-body-toc-text">避免中文乱码</span></a><ol class="post-body-toc-child"><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#const-char-转QString"><span class="post-body-toc-text">const char *转QString</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#QString转const-char"><span class="post-body-toc-text">QString转const char *</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#QString转std-string"><span class="post-body-toc-text">QString转std::string</span></a></li><li class="post-body-toc-item post-body-toc-level-2"><a class="post-body-toc-link" href="#std-string转QString"><span class="post-body-toc-text">std::string转QString</span></a></li></ol></li></ol>
      
      
        <p><img src="/images/KvImage-v1.0.gif" alt="KvImage-v1.0"></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>在这之前我们预装好了VS2019，这部分主要介绍qt的安装、VS插件的安装和编写Hello World程序。</p>
<p>下载地址推荐以下几个：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>来源</th>
<th>地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>官方</td>
<td><a href="https://download.qt.io/archive/" target="_blank" rel="noopener">https://download.qt.io/archive/</a></td>
</tr>
<tr>
<td>清华</td>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/qt/archive/</a></td>
</tr>
<tr>
<td>北理</td>
<td><a href="https://mirrors.bit.edu.cn/qtproject/archive/" target="_blank" rel="noopener">https://mirrors.bit.edu.cn/qtproject/archive/</a></td>
</tr>
<tr>
<td>Geekpie（上海科技大学）</td>
<td><a href="https://mirrors-wan.geekpie.club/qtproject/archive/" target="_blank" rel="noopener">https://mirrors-wan.geekpie.club/qtproject/archive/</a></td>
</tr>
<tr>
<td>中科大</td>
<td><a href="http://mirrors.ustc.edu.cn/qtproject/archive/" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/qtproject/archive/</a></td>
</tr>
</tbody>
</table>
</div>
<h2 id="Qt的安装"><a href="#Qt的安装" class="headerlink" title="Qt的安装"></a>Qt的安装</h2><p>之前下了个<a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/5.9/5.9.0/qt-opensource-windows-x86-5.9.0.exe" target="_blank" rel="noopener">qt-opensource-windows-x86-5.9.0.exe</a>，只装了MinGW5.3.0_32版本，在VS2019中无法添加使用，再加上想要试试最新的版本Qt5.12，因此决定把原先Qt和Qt Creator的删掉，重新装一个支持MSVC和MinGW版本的。</p>
<p>在<a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/5.12/5.12.9/" target="_blank" rel="noopener">清华镜像/qt/archive/qt/5.12/5.12.9</a>下载<a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/5.12/5.12.9/qt-opensource-windows-x86-5.12.9.exe" target="_blank" rel="noopener">qt-opensource-windows-x86-5.12.9.exe</a>，下载后运行程序，一直点击下一步即可完成安装。需要注意的几点：1. 需要有个Qt的账号并验证登录才能继续安装；2. 安装目录可以自定义，可修改至非系统盘；3. 在组件选择中，需要注意区分，在上方的<code>Qt 5.12.9</code>中有一个MinGW 7.3.0，下方的<code>Developer and Designer Tools</code>中也有一个，它们的区别在于，上方的是Qt通过MinGW 7.3.0编译的发行版（dll, lib, include），而下方的是在Qt Creator中要使用的<strong>应用程序编译和构建工具</strong>。</p>
<p><img src="/images/image-20210404175740602.png" alt="image-20210404175740602" style="zoom:45%;" /></p>
<p>安装完成后，记住安装目录，进入下一步：在VS2019中引入Qt。</p>
<hr>
<p>（下面是一些版本声明和个人看法）</p>
<p>由于Qt公司的某些原因，5.15及之后版本的Qt不再支持离线安装包（官方声明如下）</p>
<blockquote>
<p>Due to The Qt Company offering changes, open source offline installers are not available any more since Qt 5.15. Read more about offering changes in the <a href="https://www.qt.io/blog/qt-offering-changes-2020" target="_blank" rel="noopener">https://www.qt.io/blog/qt-offering-changes-2020</a> blog.</p>
<p>If you need offline installers, please consider our new Qt for Small Business offering: <a href="https://www.qt.io/blog/available-now-qt-for-small-businesses" target="_blank" rel="noopener">https://www.qt.io/blog/available-now-qt-for-small-businesses</a></p>
<hr>
<p>from <a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/5.15/5.15.0/OFFLINE_README.txt" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/5.15/5.15.0/OFFLINE_README.txt</a></p>
</blockquote>
<p>这里推荐下载离线安装包，可以避免在线安装的代理问题，可以通过国内镜像下载，速度快，稳定性好。</p>
<p>Qt版本的选择有点讲究，之前安装的5.9是一个长期支持版本（LTS），下一个是5.12，接着是5.15。5.9版本于2020年5月停止维护，其中5.9.9算是一个比较稳定的版本，可以使用；5.12是最后一个支持离线安装包的LTS版本的Qt，但是其三年的维护时限将于2021年12月结束，如果需要更新，就不得不使用在线安装的功能；5.15只能通过在线安装的方式获取，但其支持周期或许会更长，也被视为Qt6的过渡版本。不过总的来说，<strong>如果只是为了入门学习Qt的基本特性，或者在实际应用中对软件的需求不发生根本性改变，那么固定使用一个版本会是一个好的选择，5.9.9和5.12.9都是不错的版本。</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Qt版本</th>
<th>持续支持时间</th>
<th>依据</th>
</tr>
</thead>
<tbody>
<tr>
<td>5.9</td>
<td>2017年5月-2020年5月</td>
<td><a href="https://www.qt.io/blog/support-of-qt-5.9-lts-ends-in-may-2020" target="_blank" rel="noopener">https://www.qt.io/blog/support-of-qt-5.9-lts-ends-in-may-2020</a></td>
</tr>
<tr>
<td>5.12</td>
<td>2018年12月-2021年12月</td>
<td><a href="https://www.qt.io/zh-cn/blog/2018/12/17/qt-5-12-lts-released" target="_blank" rel="noopener">https://www.qt.io/zh-cn/blog/2018/12/17/qt-5-12-lts-released</a></td>
</tr>
<tr>
<td>5.15</td>
<td>2020年6月-2023年6月</td>
<td><a href="https://www.qt.io/zh-cn/blog/qt-5.15-released" target="_blank" rel="noopener">https://www.qt.io/zh-cn/blog/qt-5.15-released</a></td>
</tr>
</tbody>
</table>
</div>
<h2 id="VS插件的安装"><a href="#VS插件的安装" class="headerlink" title="VS插件的安装"></a>VS插件的安装</h2><p>VS插件（Qt VS Tools）可以在<a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/" target="_blank" rel="noopener">清华镜像/qt/archive/vsaddin</a>下载获得，这边<strong>不推荐安装最新版本</strong>的，经过几次的尝试，发现最新版本的Qt VS Tools插件（2.7.x）安装成功后，添加<code>qmake.exe</code>后点击确定，再次进如配置窗口时之前的添加结果就消失了，下面是一个踩坑列表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Qt VS Tools版本</th>
<th>下载路径</th>
<th>能否成功添加qmake</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.7.1/qt-vsaddin-msvc2019-2.7.1.vsix" target="_blank" rel="noopener">qt-vsaddin-msvc2019-2.7.1.vsix</a></td>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.7.1/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.7.1/</a></td>
<td>❌</td>
</tr>
<tr>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/development_releases/vsaddin/2.7.0/qt-vsaddin-msvc2019-2.7.0.vsix" target="_blank" rel="noopener">qt-vsaddin-msvc2019-2.7.0.vsix</a></td>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/development_releases/vsaddin/2.7.0/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/qt/development_releases/vsaddin/2.7.0/</a></td>
<td>❌</td>
</tr>
<tr>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/development_releases/vsaddin/2.7.0/qt-vsaddin-msvc2019-2.7.0-rev.28.vsix" target="_blank" rel="noopener">qt-vsaddin-msvc2019-2.7.0-rev.28.vsix</a></td>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/development_releases/vsaddin/2.7.0/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/qt/development_releases/vsaddin/2.7.0/</a></td>
<td>❌</td>
</tr>
<tr>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.4.3/qt-vsaddin-msvc2019-2.4.3.vsix" target="_blank" rel="noopener">qt-vsaddin-msvc2019-2.4.3.vsix</a></td>
<td><a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.4.3/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.4.3/</a></td>
<td>⭕</td>
</tr>
</tbody>
</table>
</div>
<p>最后还是装了一个较老的版本<a href="https://mirrors.tuna.tsinghua.edu.cn/qt/archive/vsaddin/2.4.3/qt-vsaddin-msvc2019-2.4.3.vsix" target="_blank" rel="noopener">qt-vsaddin-msvc2019-2.4.3.vsix</a>。插件下载后双击运行，若电脑上已安装VS2019，则直接按照提示安装即可。安装完成后，打开VS2019，若出现如下错误，有两种解决方式：1. 使用老版本，例如将2.7.1改成2.4.3；2. 打开Visual Studio Installer，<strong>对VS2019进行更新</strong>，更新后重新运行<code>.vsix</code>文件，即可安装成功。</p>
<p><img src="/images/image-20210327164249008.png" alt="image-20210327164249008" style="zoom:50%;" /></p>
<p>安装成功后，打开VS2019，在上方找到“扩展”，可以看到多了一个“Qt VS Tools”</p>
<p><img src="/images/image-20210327222045440.png" alt="image-20210327222045440" style="zoom:50%;" /></p>
<p>在下方的Qt Options添加Qt（其他版本的插件界面有所差异）：</p>
<p><img src="/images/image-20210327222129162.png" alt="image-20210327222129162" style="zoom:50%;" /></p>
<p>注意，在VS中添加的Qt只能是MSVC编译器的。</p>
<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>添加VS的Qt插件之后，创建新项目时多了一些诸如Qt Console Application的项目类型，这里创建一个Qt GUI Application，一路点击下一步，自动创建工程。</p>
<p><img src="/images/image-20210404201139344.png" alt="image-20210404201139344" style="zoom: 50%;" /></p>
<p>这里给工程命名<code>KvImage</code>，这个名称用于文章后面区分文件名使用。创建工程后，找到“解决方案资源管理器”，双击打开xxx.ui文件，VS会自动打开Qt Designer用于软件布局设置。</p>
<p><img src="/images/image-20210404211148671.png" alt="image-20210404211148671" style="zoom: 33%;" /></p>
<p>在Qt Designer的左侧拖动一个Label到主界面中，在属性中将其objectName命名为<code>main_label</code>，保存。此时回到VS，按下F5调试，可以看到生成一个应用程序窗口，中间有一个写着TextLabel的控件。</p>
<p><img src="/images/image-20210404211941464.png" alt="image-20210404211941464" style="zoom:50%;" /></p>
<p>接下来我们通过代码来设置这个控件的一些属性。打开<code>KvImage.h</code>，如果语句<code>#include &quot;ui_KvImage.h&quot;</code>报错提示无法打开文件，只需要将生成模式分别调成Debug和Release后执行一下调试即可，这个文件属于构建过程中自动生成的文件，不需要担心其存在性问题。打开<code>KvImage.cpp</code>，在构造函数的<code>ui.setupUi(this);</code>语句下方添加获取控件并修改其内容的语句，如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ui.centralWidget-&gt;findChild&lt;QLabel*&gt;(<span class="string">"main_label"</span>)-&gt;setText(<span class="string">"Hello World"</span>);</span><br></pre></td></tr></table></figure>
<p>添加的Label位于名为centralWidget的控件中，使用findChild获得Label后设置文字，运行程序后得到如下效果：</p>
<p><img src="/images/image-20210404223952398.png" alt="image-20210404223952398" style="zoom: 50%;" /></p>
<h3 id="问题1-没有与指定类型匹配的重载函数"><a href="#问题1-没有与指定类型匹配的重载函数" class="headerlink" title="问题1 没有与指定类型匹配的重载函数"></a>问题1 没有与指定类型匹配的重载函数</h3><p>工程创建后如果遇到如下问题：没有与指定类型匹配的重载函数<em>*</em></p>
<p><img src="/images/image-20210404201222288.png" alt="image-20210404201222288" style="zoom:50%;" /></p>
<p>可以通过手动引入include目录来消除这个报错。添加的位置：项目-属性-C/C++-常规-附加包含目录</p>
<p><img src="/images/image-20210404201641592.png" alt="image-20210404201641592" style="zoom:50%;" /></p>
<h3 id="问题2-ERROR-running-qmake"><a href="#问题2-ERROR-running-qmake" class="headerlink" title="问题2 ERROR running qmake"></a>问题2 ERROR running qmake</h3><p>点击生成或调试运行时出现的问题，由于没有指定变量QMAKE_MSC_VER。</p>
<p><img src="/images/image-20210404201734798.png" alt="image-20210404201734798" style="zoom:50%;" /></p>
<p>这个问题有个比较拙劣的解决方式：打开<code>msvc-version.conf</code>，位于安装目录下，<code>D:\Qt\Qt5.12.9\5.12.9\msvc2017\mkspecs\common\msvc-version.conf</code>，打开后找到VS2019对应的版本号，然后在文件的第一行手动写上。这样的好处在于直接解决问题，坏处就在于把VS的版本写死了，在其他的IDE中使用该版本的Qt，需要重新修改。</p>
<p><img src="/images/image-20210404202311477.png" alt="image-20210404202311477" style="zoom:50%;" /></p>
<p>修改完成后，回到VS，点击调试或运行，即可成功生成应用。</p>
<h3 id="彻底解决问题1与问题2"><a href="#彻底解决问题1与问题2" class="headerlink" title="彻底解决问题1与问题2"></a>彻底解决问题1与问题2</h3><p>很显然，以上两个问题的解决方式都是为了解决燃眉之急，治标不治本。那么问题来了，安装好Qt和VS插件之后，为什么会出现这样的问题？</p>
<p>试验发现，通过设定变量<code>QMAKE_MSC_VER</code>之后，重新创建工程不会出现任何问题，问题1与问题2在修改了<code>msvc-version.conf</code>中的变量之后得到了解决。将注意力转移到这个变量上，为什么这个变量的设置会出现问题？</p>
<p>这个回答给了一个解决的思路：<a href="https://stackoverflow.com/questions/53665166/qmake-msc-ver-isnt-set" target="_blank" rel="noopener">https://stackoverflow.com/questions/53665166/qmake-msc-ver-isnt-set</a></p>
<blockquote>
<p>Try removing any .qmake.stash files in your projects. This fixed this  same issue for me when building QT from source after previously building with a different target.</p>
</blockquote>
<p>在工程中并没有找到任何.qmake.stash文件，全局搜索后，发现<strong>在用户文件夹下有一个.qmake.stash</strong>，会不会是它影响了VS的行为？</p>
<p>首先将<code>msvc-version.conf</code>中添加的第一行<code>QMAKE_MSC_VER=1919</code>去掉，接着将用户文件夹下的.qmake.stash删除。重新打开VS2019创建工程，发现从创建到生成到运行，没有出现任何问题！破案了，就是这个文件导致的VS2019行为异常。因此，<strong>只需要将用户文件夹下的<code>.qmake.stash</code>删除，就可以解决问题1与问题2，不需要更改任何配置文件。</strong></p>
<h1 id="添加基础功能示例：打开一幅图像"><a href="#添加基础功能示例：打开一幅图像" class="headerlink" title="添加基础功能示例：打开一幅图像"></a>添加基础功能示例：打开一幅图像</h1><h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h2><p>在Qt Designer中，双击菜单栏，添加一个菜单，命名为“开始”，然后在下面添加一个选项，注意添加的时候只能用英文命名，例如“open_image”，添加后，再到属性列表中修改其text属性为中文“打开图像”。</p>
<p><img src="/images/image-20210405180352839.png" alt="image-20210405180352839" style="zoom:50%;" /></p>
<p>或者直接在动作窗口新建动作，接着再把动作拖到软件的菜单栏中。</p>
<p><img src="/images/image-20210405180434022.png" alt="image-20210405180434022" style="zoom:50%;" /></p>
<p>接下来添加该动作的点击（triggered）响应事件。在类KvImage的声明中，添加私有成员函数<code>on_action_open_image_triggered</code>，代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KvImage</span> :</span> <span class="keyword">public</span> QMainWindow</span><br><span class="line">&#123;</span><br><span class="line">	Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	KvImage(QWidget *parent = Q_NULLPTR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">on_action_open_image_triggered</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	Ui::KvImageClass ui;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接着在<code>KvImage.cpp</code>中添加其实现：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::on_action_open_image_triggered</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>action_open_image</code>对应动作的名称，triggered是动作的信号，<code>on_动作名_信号()</code>是默认的响应函数格式。创建的动作属于<a href="https://doc.qt.io/qt-5.12/qaction.html" target="_blank" rel="noopener">QAction类</a>，其自带的信号包括以下几种（<a href="https://doc.qt.io/qt-5.12/qaction.html#signals）：" target="_blank" rel="noopener">https://doc.qt.io/qt-5.12/qaction.html#signals）：</a></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>信号</th>
<th>类</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>changed()</code></td>
<td>QAction</td>
</tr>
<tr>
<td><code>hovered()</code></td>
<td>QAction</td>
</tr>
<tr>
<td><code>toggled()</code></td>
<td>QAction</td>
</tr>
<tr>
<td><code>triggered()</code></td>
<td>QAction</td>
</tr>
<tr>
<td><code>triggered(bool)</code></td>
<td>QAction</td>
</tr>
<tr>
<td><code>destroyed()</code></td>
<td>QObject</td>
</tr>
<tr>
<td><code>destroyed(QObject*)</code></td>
<td>QObject</td>
</tr>
</tbody>
</table>
</div>
<p>图像的显示就使用Label设置Pixmap即可。理论上来讲显示图片用Graphics View更好，但是其封装性太好，在之前的尝试中发现其可控性并不是很高。由于在本次开发中图片的显示只是最基础的一环，且在涉及到计算机图形学的编程（基于显示窗口的缩放、旋转等）时，Graphics View没有办法提供很好的交互，还是得将图片提出来计算显示窗口并操作显示窗口的内容，而这种功能基于Label就能实现，没必要用到封装性好的Graphics View。</p>
<p>由于涉及到大量对Label的操作，将其存放到类的变量中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KvImage.h</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	Ui::KvImageClass ui;</span><br><span class="line"></span><br><span class="line">	QLabel* mLabel;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// KvImage.cpp</span></span><br><span class="line">KvImage::KvImage(QWidget *parent)</span><br><span class="line">	: QMainWindow(parent)</span><br><span class="line">&#123;</span><br><span class="line">	ui.setupUi(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function">QString <span class="title">mainLabelName</span><span class="params">(<span class="string">"main_label"</span>)</span></span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;mLabel = ui.centralWidget-&gt;findChild&lt;QLabel*&gt;(mainLabelName);</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;mLabel)</span><br><span class="line">	&#123;</span><br><span class="line">		qFatal(QString(<span class="string">"QLabel [%1] not found!"</span>).arg(mainLabelName).toLocal8Bit());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="打开图像文件对话框"><a href="#打开图像文件对话框" class="headerlink" title="打开图像文件对话框"></a>打开图像文件对话框</h2><p>在头文件<code>KvImage.h</code>中引入文件对话框的类：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QFileDialog&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>打开对话框的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过对话框获取文件路径</span></span><br><span class="line">QString caption = QString::fromLocal8Bit(<span class="string">"选择一个文件打开"</span>);</span><br><span class="line">QString dir = <span class="string">""</span>;  <span class="comment">// 为空默认记忆上一次打开的路径</span></span><br><span class="line"><span class="function">QString <span class="title">filter</span><span class="params">(<span class="string">"Image (*.png *.jpg *.jped *.tif *.bmp"</span>)</span></span>;</span><br><span class="line">QString fileName = QFileDialog::getOpenFileName(</span><br><span class="line"><span class="keyword">this</span>, caption, dir, filter</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fileName.isEmpty())</span><br><span class="line">&#123;</span><br><span class="line">    qWarning() &lt;&lt; QString::fromLocal8Bit(<span class="string">"KvImage::on_action_open_image_triggered - 未选择图片路径"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">qInfo() &lt;&lt; QString::fromLocal8Bit(<span class="string">"打开图像 (%1)"</span>).arg(fileName);</span><br></pre></td></tr></table></figure>
<p>如果直接使用<code>QString caption(&quot;选择一个文件打开&quot;);</code>，文件对话框的标题会是乱码。</p>
<h2 id="使用OpenCV读取图像"><a href="#使用OpenCV读取图像" class="headerlink" title="使用OpenCV读取图像"></a>使用OpenCV读取图像</h2><p>OpenCV提供了许多现成的计算机视觉算法，是图像处理的基础类库之一，在图像处理软件中是必备的存在。</p>
<p>OpenCV需要经过编译，编译的过程可参考<a href="../_posts/2020-06-14-Windows下编译OpenCV-3-1-0-扩展opencv-contrib.md">另一篇博客</a>或Google搜索，编译的产物为三件套：dll，include和lib，分为debug和release版本。</p>
<p>首先在VS工程的目录下新建文件夹lib，在lib中新建debug和release，若工程目录下不存在Debug或Release，则分别创建一个，或者打开VS分别生成（Ctrl + Shift + B）一下debug版本和release版本的工程，会自动生成，此时工程的目录如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|-Debug</span><br><span class="line">|-include</span><br><span class="line">|-KvImage</span><br><span class="line">|-lib</span><br><span class="line">|-|-debug</span><br><span class="line">|-|-release</span><br><span class="line">|-Release</span><br><span class="line">|-KvImage.sln</span><br></pre></td></tr></table></figure>
<p>将include拷贝到工程目录下（debug和release没有区别），然后把所有debug版本的.lib文件拷贝到lib/debug下，release版本的拷贝到lib/release下。将debug版本的.dll文件拷贝到Debug下，release版本的拷贝到Release下：</p>
<p><img src="/images/image-20210405190551306.png" alt="image-20210405190551306" style="zoom:50%;" /></p>
<p>文件拷贝完成后，打开VS2019，项目-属性-C/C++-常规-附加包含目录，添加一项：<code>../include</code>，项目-属性-链接器-输入-附加依赖项，添加一项：<code>../lib/release/*.lib</code>，如果构建类型是debug，就添加<code>../lib/debug/*.lib</code>。</p>
<p>此时，在<code>KvImage.h</code>添加OpenCV的引入：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>接着，在打开图像文件对话框的代码之后添加：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat img = cv::imread(fileName.toLocal8Bit().toStdString());</span><br><span class="line">cv::namedWindow(<span class="string">"img"</span>, <span class="number">0</span>);</span><br><span class="line">imshow(<span class="string">"img"</span>, img);</span><br><span class="line">cv::waitKey();</span><br></pre></td></tr></table></figure>
<p>此时，打开图像后，会通过OpenCV自带的图像窗口显示图像。</p>
<h2 id="OpenCV与QImage和QPixmap的相互转化"><a href="#OpenCV与QImage和QPixmap的相互转化" class="headerlink" title="OpenCV与QImage和QPixmap的相互转化"></a>OpenCV与QImage和QPixmap的相互转化</h2><blockquote>
<p><a href="https://blog.csdn.net/qq_17550379/article/details/78683153" target="_blank" rel="noopener">https://blog.csdn.net/qq_17550379/article/details/78683153</a></p>
</blockquote>
<p>为什么要用OpenCV？为了之后的图像处理操作以及图像显示操作方便，有很多现有的算法是用OpenCV编写，为了避免重构，必须探索在Qt软件中直接显示OpenCV处理结果的途径。</p>
<p>QImage和QPixmap的转换可以通过如下形式，而Mat与两者之间的转换需要额外的代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QImage 转 QPixmap</span></span><br><span class="line">QImage qimg;</span><br><span class="line">QPixmap pxm = QPixmap::fromImage(qimg);</span><br><span class="line"></span><br><span class="line"><span class="comment">// QPixmap 转 QImage</span></span><br><span class="line">QPixmap pxm;</span><br><span class="line">QImage qimg = pxm.toImage();</span><br></pre></td></tr></table></figure>
<p>在工程中创建类<code>Transform</code>专门用于处理转换（数据格式转换、类型转换、坐标转换等）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Transform.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transform</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Transform.cpp</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Transform.h"</span></span></span><br></pre></td></tr></table></figure>
<p>分别添加几个静态成员函数用于处理图像数据类型转换：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transform</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">static</span> QImage <span class="title">MatToQImage</span><span class="params">(cv::Mat &amp;img)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> QPixmap <span class="title">MatToQPixmap</span><span class="params">(cv::Mat&amp; img)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> cv::Mat <span class="title">QPixmapToMat</span><span class="params">(QPixmap&amp; pxm)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">static</span> cv::Mat <span class="title">QImageToMat</span><span class="params">(QImage&amp; qimg)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QImage <span class="title">Transform::MatToQImage</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (img.type())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 8-bit, 4 channel</span></span><br><span class="line">    <span class="keyword">case</span> CV_8UC4:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">QImage <span class="title">image</span><span class="params">(img.data,</span></span></span><br><span class="line"><span class="function"><span class="params">            img.cols, img.rows,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(img.<span class="built_in">step</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">            QImage::Format_ARGB32)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">image</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8-bit, 3 channel</span></span><br><span class="line">    <span class="keyword">case</span> CV_8UC3:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">QImage <span class="title">image</span><span class="params">(img.data,</span></span></span><br><span class="line"><span class="function"><span class="params">            img.cols, img.rows,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(img.<span class="built_in">step</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">            QImage::Format_RGB888)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">image</span>.rgbSwapped();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8-bit, 1 channel</span></span><br><span class="line">    <span class="keyword">case</span> CV_8UC1:</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> QT_VERSION &gt;= QT_VERSION_CHECK(5, 5, 0)</span></span><br><span class="line">        <span class="function">QImage <span class="title">image</span><span class="params">(img.data,</span></span></span><br><span class="line"><span class="function"><span class="params">            img.cols, img.rows,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(img.<span class="built_in">step</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">            QImage::Format_Grayscale8)</span></span>;  <span class="comment">//Format_Alpha8 and Format_Grayscale8 were added in Qt 5.5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        <span class="keyword">static</span> QVector&lt;QRgb&gt;  sColorTable;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// only create our color table the first time</span></span><br><span class="line">        <span class="keyword">if</span> (sColorTable.isEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            sColorTable.resize(<span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                sColorTable[i] = qRgb(i, i, i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">QImage <span class="title">image</span><span class="params">(img.data,</span></span></span><br><span class="line"><span class="function"><span class="params">            img.cols, img.rows,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(img.<span class="built_in">step</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">            QImage::Format_Indexed8)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">image</span>.setColorTable(sColorTable);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">image</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        qWarning() &lt;&lt; <span class="string">"Transform::MatToQImage() - cv::Mat image type not handled in switch: "</span> &lt;&lt; img.type();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> QImage();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">QPixmap <span class="title">Transform::MatToQPixmap</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QPixmap::fromImage(Transform::MatToQImage(img));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">cv::Mat <span class="title">Transform::QImageToMat</span><span class="params">(<span class="keyword">const</span> QImage&amp; qimg, <span class="keyword">bool</span> cloneImageData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (qimg.format())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 8-bit, 4 channel</span></span><br><span class="line">    <span class="keyword">case</span> QImage::Format_ARGB32:</span><br><span class="line">    <span class="keyword">case</span> QImage::Format_ARGB32_Premultiplied:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">cv::Mat <span class="title">mat</span><span class="params">(qimg.<span class="built_in">height</span>(), qimg.<span class="built_in">width</span>(),</span></span></span><br><span class="line"><span class="function"><span class="params">            CV_8UC4,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const_cast</span>&lt;uchar*&gt;(qimg.bits()),</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(qimg.bytesPerLine())</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (cloneImageData ? mat.clone() : mat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8-bit, 3 channel</span></span><br><span class="line">    <span class="keyword">case</span> QImage::Format_RGB32:</span><br><span class="line">    <span class="keyword">case</span> QImage::Format_RGB888:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!cloneImageData)</span><br><span class="line">        &#123;</span><br><span class="line">            qWarning() &lt;&lt; <span class="string">"Transform::QImageToMat() - Conversion requires cloning because we use a temporary QImage"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        QImage   swapped = qimg;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (qimg.format() == QImage::Format_RGB32)</span><br><span class="line">        &#123;</span><br><span class="line">            swapped = swapped.convertToFormat(QImage::Format_RGB888);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        swapped = swapped.rgbSwapped();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cv::Mat(swapped.<span class="built_in">height</span>(), swapped.<span class="built_in">width</span>(),</span><br><span class="line">            CV_8UC3,</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;uchar*&gt;(swapped.bits()),</span><br><span class="line">            <span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(swapped.bytesPerLine())</span><br><span class="line">        ).clone();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8-bit, 1 channel</span></span><br><span class="line">    <span class="keyword">case</span> QImage::Format_Indexed8:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">cv::Mat <span class="title">mat</span><span class="params">(qimg.<span class="built_in">height</span>(), qimg.<span class="built_in">width</span>(),</span></span></span><br><span class="line"><span class="function"><span class="params">            CV_8UC1,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">const_cast</span>&lt;uchar*&gt;(qimg.bits()),</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">static_cast</span>&lt;<span class="keyword">size_t</span>&gt;(qimg.bytesPerLine())</span></span></span><br><span class="line"><span class="function"><span class="params">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (cloneImageData ? mat.clone() : mat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        qWarning() &lt;&lt; <span class="string">"Transform::QImageToMat() - QImage format not handled in switch: "</span> &lt;&lt; qimg.format();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cv::Mat();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">cv::Mat <span class="title">Transform::QPixmapToMat</span><span class="params">(<span class="keyword">const</span> QPixmap&amp; pxm, <span class="keyword">bool</span> cloneImageData)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Transform::QImageToMat(pxm.toImage(), cloneImageData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="在QLabel中显示图像QPixmap"><a href="#在QLabel中显示图像QPixmap" class="headerlink" title="在QLabel中显示图像QPixmap"></a>在QLabel中显示图像QPixmap</h2><h3 id="基本设置方法"><a href="#基本设置方法" class="headerlink" title="基本设置方法"></a>基本设置方法</h3><p>一句话</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cv::Mat img = cv::imread(fileName.toLocal8Bit().toStdString());</span><br><span class="line"><span class="keyword">this</span>-&gt;mLabel-&gt;setPixmap(Transform::MatToQPixmap(img));</span><br></pre></td></tr></table></figure>
<p>可以将图像设为全局变量和并打印属性信息：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>-&gt;mImg = cv::imread(fileName.toLocal8Bit().toStdString());</span><br><span class="line">qInfo() &lt;&lt; QString::fromLocal8Bit(<span class="string">"图像尺寸：width=%1px, height=%2px"</span>)</span><br><span class="line">    .arg(<span class="keyword">this</span>-&gt;mImg.cols)</span><br><span class="line">    .arg(<span class="keyword">this</span>-&gt;mImg.rows);</span><br></pre></td></tr></table></figure>
<p>当然了，这里是用到了OpenCV读取图片并转换，考虑到后续需要大量使用OpenCV转QPixmap的操作，进行一次预演。如果只需要从一个文件读取图片数据放到QPixmap中，可以用如下方法：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QPixmap pxm;</span><br><span class="line">pxm.load(fileName);  <span class="comment">// 直接输入图片文件的文件名</span></span><br><span class="line"><span class="keyword">this</span>-&gt;mLabel-&gt;setPixmap(pxm);</span><br></pre></td></tr></table></figure>
<p>通过上述语句设置，位图在QLabel中的大小保持原图不变，可能出现显示不全或边缘留白的问题，根本原因是以上操作没有改变位图大小，从而导致是以原图尺寸在QLabel中显示。为了解决这个问题，需要重载<code>Transform::MatToQPixmap()</code>函数，加入大小和位置控制的参数，有以下两种实现思路。</p>
<h3 id="指定显示区域尺寸的位图"><a href="#指定显示区域尺寸的位图" class="headerlink" title="指定显示区域尺寸的位图"></a>指定显示区域尺寸的位图</h3><p>为了保证图片在显示区域（QLabel）中合理显示，需要考虑两个尺度的问题：图像尺寸超出显示区，缩放以适合；图像尺寸小于显示区，放大以填充。这部分设计不仅能为<u>单图片显示应用</u>中提供<u>保证图片大小随窗口拖动而变化</u>的支持，还能提供一个按钮接口，当点击按钮时使图片适应窗口。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QImage <span class="title">Transform::MatToQImage</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img, cv::Size imgSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cv::Mat src = img;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> xScale, yScale;</span><br><span class="line">    xScale = <span class="keyword">double</span>(imgSize.<span class="built_in">width</span>) / <span class="keyword">double</span>(src.cols);</span><br><span class="line">    yScale = <span class="keyword">double</span>(imgSize.<span class="built_in">height</span>) / <span class="keyword">double</span>(src.rows);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">double</span> scale = <span class="built_in">std</span>::<span class="built_in">min</span>(xScale, yScale);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resizeHeight, resizeWidth;</span><br><span class="line">    resizeHeight = src.rows * scale;</span><br><span class="line">    resizeWidth = src.cols * scale;</span><br><span class="line">    cv::resize(src, src, cv::Size(resizeWidth, resizeHeight));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Transform::MatToQImage(src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="★★★同时指定显示区域尺寸和图像矩形的位图"><a href="#★★★同时指定显示区域尺寸和图像矩形的位图" class="headerlink" title="★★★同时指定显示区域尺寸和图像矩形的位图"></a>★★★同时指定显示区域尺寸和图像矩形的位图</h3><p>当考虑到图像的移动和缩放时，图像相对于显示区的位置会发生改变，此时的显示场景较为复杂，图片随窗口大小变化的情形不适用。考虑在显示时加入图像相对于显示区的矩形，显示时取图像矩形和显示区矩形的交集，绘制位图。</p>
<p>基本流程是：将显示视图和图像矩形取出来，计算交集，若无交集，直接绘制黑色底图；若有交集，则计算需要出现在视图区内的图像像素。这里考虑到图像矩形和原图并不一定等大，因此需要在区域选取前进行一定的缩放：先获取图像显示部分的矩形，再将该矩形映射到原图上，取原图的像素再调整尺寸到显示部分矩形的大小。</p>
<p>最后将调整大小后的像素铺到显示区视图上，完成函数输出。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QImage <span class="title">Transform::MatToQImage</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img, cv::Size viewSize, cv::Rect imgRect)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 视图区矩形</span></span><br><span class="line">    <span class="function">cv::Rect <span class="title">viewRect</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, viewSize.<span class="built_in">width</span>, viewSize.<span class="built_in">height</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 图像显示的矩形</span></span><br><span class="line">    cv::Rect imgViewRect = viewRect &amp; imgRect;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果图像矩形位于显示区内</span></span><br><span class="line">    <span class="keyword">if</span> (imgViewRect != cv::Rect())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 背景图</span></span><br><span class="line">        cv::Mat viewImg = cv::Mat::zeros(viewSize, img.type());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将图片上要显示的区域提取出来</span></span><br><span class="line">        <span class="comment">// 由于图像矩形和原图并不一定等大，因此需要进行区域选取处理</span></span><br><span class="line">        cv::Rect rawImgRect;</span><br><span class="line">        <span class="comment">// 获取相对于图像左上角的坐标</span></span><br><span class="line">        rawImgRect.x = (imgViewRect.x - imgRect.x) * img.cols / imgRect.<span class="built_in">width</span>;</span><br><span class="line">        rawImgRect.y = (imgViewRect.y - imgRect.y) * img.rows / imgRect.<span class="built_in">height</span>;</span><br><span class="line">        <span class="comment">// 获取实际宽高</span></span><br><span class="line">        rawImgRect.<span class="built_in">width</span> = imgViewRect.<span class="built_in">width</span> * img.cols / imgRect.<span class="built_in">width</span>;</span><br><span class="line">        rawImgRect.<span class="built_in">height</span> = imgViewRect.<span class="built_in">height</span> * img.rows / imgRect.<span class="built_in">height</span>;</span><br><span class="line"></span><br><span class="line">        cv::Mat src = img(rawImgRect).clone();</span><br><span class="line">        cv::resize(src, src, cv::Size(imgViewRect.<span class="built_in">width</span>, imgViewRect.<span class="built_in">height</span>));</span><br><span class="line">        src.copyTo(viewImg(imgViewRect));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Transform::MatToQImage(viewImg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果图像矩形不位于显示区内，直接显示黑图</span></span><br><span class="line">    <span class="function">QImage <span class="title">image</span><span class="params">(viewSize.<span class="built_in">width</span>, viewSize.<span class="built_in">height</span>, QImage::Format_RGB888)</span></span>;</span><br><span class="line">    <span class="built_in">image</span>.<span class="built_in">fill</span>(Qt::GlobalColor::black);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">image</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="showImage图像显示接口函数"><a href="#showImage图像显示接口函数" class="headerlink" title="showImage图像显示接口函数"></a>showImage图像显示接口函数</h3><p>为了方便在QLabel中显示Mat图片，这里设置了一些函数接口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::showImage</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!img.data)</span><br><span class="line">	&#123;</span><br><span class="line">		qWarning() &lt;&lt; <span class="string">"KvImage::showImage() - Mat is Empty!"</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">time_t</span> t = cv::getTickCount();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;mLabel-&gt;setPixmap(Transform::MatToQPixmap(img,</span><br><span class="line">		cv::Size(<span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">width</span>(), <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">height</span>())));</span><br><span class="line"></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"KvImage::showImage() - Cost time: "</span></span><br><span class="line">		&lt;&lt; (<span class="keyword">double</span>(cv::getTickCount() - t) / cv::getTickFrequency()) &lt;&lt; <span class="string">"s"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::showImage</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img, cv::Rect imgRect)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!img.data)</span><br><span class="line">	&#123;</span><br><span class="line">		qWarning() &lt;&lt; <span class="string">"KvImage::showImage() - Mat is Empty!"</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">time_t</span> t = cv::getTickCount();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;mLabel-&gt;setPixmap(Transform::MatToQPixmap(img,</span><br><span class="line">		cv::Size(<span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">width</span>(), <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">height</span>()), imgRect));</span><br><span class="line"></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"KvImage::showImage() - Cost time: "</span></span><br><span class="line">		&lt;&lt; (<span class="keyword">double</span>(cv::getTickCount() - t) / cv::getTickFrequency()) &lt;&lt; <span class="string">"s"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="打开图像的响应函数"><a href="#打开图像的响应函数" class="headerlink" title="打开图像的响应函数"></a>打开图像的响应函数</h2><p>通过以上几步的操作，打开图像的函数<code>on_action_open_image_triggered</code>完整代码如下所示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::on_action_open_image_triggered</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 通过对话框获取文件路径</span></span><br><span class="line">	QString caption = QString::fromLocal8Bit(<span class="string">"选择一个文件打开"</span>);</span><br><span class="line">	QString dir = <span class="string">""</span>;  <span class="comment">// 为空默认记忆上一次打开的路径</span></span><br><span class="line">	<span class="function">QString <span class="title">filter</span><span class="params">(<span class="string">"Image (*.png *.jpg *.jpeg *.tif *.bmp)"</span>)</span></span>;</span><br><span class="line">	QString fileName = QFileDialog::getOpenFileName(</span><br><span class="line">		<span class="keyword">this</span>, caption, dir, filter</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fileName.isEmpty())</span><br><span class="line">	&#123;</span><br><span class="line">		qWarning() &lt;&lt; QString::fromLocal8Bit(<span class="string">"KvImage::on_action_open_image_triggered - 未选择图片路径"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	qInfo() &lt;&lt; QString::fromLocal8Bit(<span class="string">"打开图像 (%1)"</span>).arg(fileName);</span><br><span class="line">	<span class="keyword">this</span>-&gt;mImg = cv::imread(fileName.toLocal8Bit().toStdString());</span><br><span class="line">	qInfo() &lt;&lt; QString::fromLocal8Bit(<span class="string">"图像尺寸：width=%1px, height=%2px"</span>)</span><br><span class="line">		.arg(<span class="keyword">this</span>-&gt;mImg.cols)</span><br><span class="line">		.arg(<span class="keyword">this</span>-&gt;mImg.rows);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示图像</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="QLabel的大小及图像自适应"><a href="#QLabel的大小及图像自适应" class="headerlink" title="QLabel的大小及图像自适应"></a>QLabel的大小及图像自适应</h2><p>很遗憾的是，QLabel不支持百分比的布局方式，在窗口发生变化时其宽高并不会变化，这就导致图像显示时相当别扭。为了解决这个问题，需要设置窗口的resize事件来动态调整label宽高，且动态调整宽高后图像重新显示。</p>
<p>在<code>KvImage</code>类中添加<code>resizeEvent</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">resizeEvent</span><span class="params">(QResizeEvent* evt)</span></span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::resizeEvent</span><span class="params">(QResizeEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	QSize winSize = <span class="keyword">this</span>-&gt;<span class="built_in">size</span>(),</span><br><span class="line">		menuSize = ui.menuBar-&gt;<span class="built_in">size</span>(),</span><br><span class="line">		statusSize = ui.statusBar-&gt;<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> labelHeight = winSize.<span class="built_in">height</span>() - menuSize.<span class="built_in">height</span>() - statusSize.<span class="built_in">height</span>(),</span><br><span class="line">		labelWidth = winSize.<span class="built_in">width</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>-&gt;mLabel-&gt;setGeometry(<span class="number">0</span>, <span class="number">0</span>, labelWidth, labelHeight);</span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"KvImage::resizeEvent() - Label size is (width="</span> &lt;&lt; labelWidth</span><br><span class="line">		&lt;&lt; <span class="string">"px, height="</span> &lt;&lt; labelHeight &lt;&lt; <span class="string">"px)"</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 重新显示图片</span></span><br><span class="line">	<span class="keyword">if</span> (labelWidth &gt; <span class="number">0</span> &amp;&amp; labelHeight &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="图像缩放和拖动"><a href="#图像缩放和拖动" class="headerlink" title="图像缩放和拖动"></a>图像缩放和拖动</h2><blockquote>
<p>滚动事件：<a href="https://doc.qt.io/qt-5.12/qwheelevent.html" target="_blank" rel="noopener">https://doc.qt.io/qt-5.12/qwheelevent.html</a></p>
<p>鼠标事件：<a href="https://doc.qt.io/qt-5.12/qmouseevent.html" target="_blank" rel="noopener">https://doc.qt.io/qt-5.12/qmouseevent.html</a></p>
</blockquote>
<p>需要实现三个事件响应：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在主窗口类添加</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">wheelEvent</span><span class="params">(QWheelEvent* evt)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mousePressEvent</span><span class="params">(QMouseEvent* evt)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mouseMoveEvent</span><span class="params">(QMouseEvent* evt)</span></span>;</span><br></pre></td></tr></table></figure>
<h3 id="图像矩形的概念"><a href="#图像矩形的概念" class="headerlink" title="图像矩形的概念"></a>图像矩形的概念</h3><p>为了实现图像的拖动、缩放等交互操作，引入图像矩形的概念。考虑在窗口中添加一个存储当前图像窗口的矩形<code>mRect</code>，用于区分QLabel的矩形和图片的矩形。在图像显示控件中，应该存在两个矩形：<strong>显示区矩形</strong>（QLabel）和<strong>图像矩形</strong>。图片矩形描述图片相对于显示区矩形的空间位置，而显示区显示的将是两个<strong>矩形相交部分的图像像素</strong>。</p>
<h3 id="加入图像矩形后的程序优化"><a href="#加入图像矩形后的程序优化" class="headerlink" title="加入图像矩形后的程序优化"></a>加入图像矩形后的程序优化</h3><p>如何在显示区显示图像矩形的内容已经在本章的前面部分论述，这部分内容主要论述了加入了图像矩形后的程序修改问题。</p>
<p>在“指定区域显示位图”的函数<code>MatToQImage(const cv::Mat&amp; img, cv::Size imgSize)</code>中，有一段计算图像调整后大小的代码：当给定一个显示区，在不改变图像比例的情况下将图像完整放入这个区域，需要计算调整尺寸后图像的宽高。将其封装成一个函数，如下所示：</p>
<p>计算图像<strong>匹配窗口尺寸</strong>后的矩形：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Rect <span class="title">Transform::calcImageRect</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img, cv::Size imgSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 计算缩放比例</span></span><br><span class="line">    <span class="keyword">double</span> xScale, yScale;</span><br><span class="line">    xScale = <span class="keyword">double</span>(imgSize.<span class="built_in">width</span>) / <span class="keyword">double</span>(img.cols);</span><br><span class="line">    yScale = <span class="keyword">double</span>(imgSize.<span class="built_in">height</span>) / <span class="keyword">double</span>(img.rows);</span><br><span class="line">    <span class="keyword">double</span> scale = <span class="built_in">std</span>::<span class="built_in">min</span>(xScale, yScale);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算缩放后的图片矩形（居中显示)</span></span><br><span class="line">    cv::Rect imgRect;</span><br><span class="line">    imgRect.<span class="built_in">width</span> = <span class="keyword">int</span>(img.cols * scale);</span><br><span class="line">    imgRect.<span class="built_in">height</span> = <span class="keyword">int</span>(img.rows * scale);</span><br><span class="line">    imgRect.x = <span class="keyword">int</span>((imgSize.<span class="built_in">width</span> - imgRect.<span class="built_in">width</span>) / <span class="number">2</span>);</span><br><span class="line">    imgRect.y = <span class="keyword">int</span>((imgSize.<span class="built_in">height</span> - imgRect.<span class="built_in">height</span>) / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> imgRect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改“指定区域显示位图”的函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QImage <span class="title">Transform::MatToQImage</span><span class="params">(<span class="keyword">const</span> cv::Mat&amp; img, cv::Size imgSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cv::Mat src;</span><br><span class="line">    cv::Rect imgRect = Transform::calcImageRect(img, imgSize);</span><br><span class="line">    cv::resize(img, src, cv::Size(imgRect.<span class="built_in">width</span>, imgRect.<span class="built_in">height</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Transform::MatToQImage(src);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在打开图像时计算图像矩形，保存到全局变量并应用到显示视图上：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::on_action_open_image_triggered</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 计算图片矩形</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;mRect = Transform::calcImageRect(<span class="keyword">this</span>-&gt;mImg, cv::Size(<span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">width</span>(), <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">height</span>()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 显示图像</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg, <span class="keyword">this</span>-&gt;mRect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>缩放事件触发时响应更改：图片矩形保持不变。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::resizeEvent</span><span class="params">(QResizeEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">// 重新显示图片</span></span><br><span class="line">	<span class="keyword">if</span> (labelWidth &gt; <span class="number">0</span> &amp;&amp; labelHeight &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>-&gt;mImg.data)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg, <span class="keyword">this</span>-&gt;mRect);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="拖动图像"><a href="#拖动图像" class="headerlink" title="拖动图像"></a>拖动图像</h3><p>由QWidget自带的<a href="https://doc.qt.io/qt-5.12/qwidget.html#protected-functions" target="_blank" rel="noopener">事件函数</a><code>mousePressEvent</code>，<code>mouseMoveEvent</code>，<code>moudeReleaseEvent</code>来跟踪鼠标移动；设定全局变量<code>double msX, msY, meX, meY</code>来记录鼠标移动的起始位置；三个事件函数的参数均为<a href="https://doc.qt.io/qt-5.12/qmouseevent.html" target="_blank" rel="noopener">QMouseEvent</a>，通过<code>QMouseEvent::localPos()</code>（<a href="https://doc.qt.io/qt-5.12/qmouseevent.html#localPos" target="_blank" rel="noopener">参考</a>）获取双浮点型坐标；在事件函数中，通过<code>QMouseEvent::button()</code>获取按键类型（左键、右键、滚轮键等，<a href="https://doc.qt.io/qt-5.12/qt.html#MouseButton-enum" target="_blank" rel="noopener">参考</a>）。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KvImage</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="comment">// mouse start x,y; mouse end x,y</span></span><br><span class="line">	<span class="keyword">double</span> msX, msY, meX, meY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::mousePressEvent</span><span class="params">(QMouseEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 接收事件，不往下传递</span></span><br><span class="line">	evt-&gt;accept();</span><br><span class="line">	QPointF pt = evt-&gt;localPos();</span><br><span class="line">	<span class="keyword">this</span>-&gt;msX = pt.x();</span><br><span class="line">	<span class="keyword">this</span>-&gt;msY = pt.y();</span><br><span class="line">	qDebug() &lt;&lt; QString(<span class="string">"KvImage::mousePressEvent() - (x=%1, y=%2)"</span>)</span><br><span class="line">		.arg(<span class="keyword">this</span>-&gt;msX).arg(<span class="keyword">this</span>-&gt;msY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::mouseMoveEvent</span><span class="params">(QMouseEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 接收事件，不往下传递</span></span><br><span class="line">	evt-&gt;accept();</span><br><span class="line">	QPointF pt = evt-&gt;localPos();</span><br><span class="line">	<span class="keyword">this</span>-&gt;meX = pt.x();</span><br><span class="line">	<span class="keyword">this</span>-&gt;meY = pt.y();</span><br><span class="line">	qDebug() &lt;&lt; QString(<span class="string">"KvImage::mouseMoveEvent() - (x=%1, y=%2)"</span>)</span><br><span class="line">		.arg(<span class="keyword">this</span>-&gt;meX).arg(<span class="keyword">this</span>-&gt;meY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>-&gt;mImg.data &amp;&amp; <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">height</span>() &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">width</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cv::Rect tRect = <span class="keyword">this</span>-&gt;mRect;</span><br><span class="line">		tRect.x += (<span class="keyword">this</span>-&gt;meX - <span class="keyword">this</span>-&gt;msX);</span><br><span class="line">		tRect.y += (<span class="keyword">this</span>-&gt;meY - <span class="keyword">this</span>-&gt;msY);</span><br><span class="line">		<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg, tRect);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::mouseReleaseEvent</span><span class="params">(QMouseEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 接收事件，不往下传递</span></span><br><span class="line">	evt-&gt;accept();</span><br><span class="line">	QPointF pt = evt-&gt;localPos();</span><br><span class="line">	<span class="keyword">this</span>-&gt;meX = pt.x();</span><br><span class="line">	<span class="keyword">this</span>-&gt;meY = pt.y();</span><br><span class="line">	qDebug() &lt;&lt; QString(<span class="string">"KvImage::mouseReleaseEvent() - (x=%1, y=%2)"</span>)</span><br><span class="line">		.arg(<span class="keyword">this</span>-&gt;meX).arg(<span class="keyword">this</span>-&gt;meY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>-&gt;mImg.data &amp;&amp; <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">height</span>() &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>-&gt;mLabel-&gt;<span class="built_in">width</span>() &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;mRect.x += (<span class="keyword">this</span>-&gt;meX - <span class="keyword">this</span>-&gt;msX);</span><br><span class="line">		<span class="keyword">this</span>-&gt;mRect.y += (<span class="keyword">this</span>-&gt;meY - <span class="keyword">this</span>-&gt;msY);</span><br><span class="line">		<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg, <span class="keyword">this</span>-&gt;mRect);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="缩放图像"><a href="#缩放图像" class="headerlink" title="缩放图像"></a>缩放图像</h3><blockquote>
<p><a href="https://doc.qt.io/qt-5.12/qwheelevent.html#public-functions" target="_blank" rel="noopener">https://doc.qt.io/qt-5.12/qwheelevent.html#public-functions</a></p>
</blockquote>
<p>首先得明白滚轮事件的一些输出，这边做了一个例子：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::wheelEvent</span><span class="params">(QWheelEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"KvImage::wheelEvent() - "</span> &lt;&lt; evt;    <span class="comment">// KvImage::wheelEvent() -  QWheelEvent(Qt::NoScrollPhase, pixelDelta=QPoint(0,0), angleDelta=QPoint(0,120))</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"angleDelta: "</span> &lt;&lt; evt-&gt;angleDelta();  <span class="comment">// angleDelta:  QPoint(0,120)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"buttons: "</span> &lt;&lt; evt-&gt;buttons();        <span class="comment">// buttons:  QFlags&lt;Qt::MouseButton&gt;(NoButton)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"globalPos: "</span> &lt;&lt; evt-&gt;globalPos();    <span class="comment">// globalPos:  QPoint(1739,635)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"globalPosF: "</span> &lt;&lt; evt-&gt;globalPosF();  <span class="comment">// globalPosF:  QPointF(1739,635)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"globalX: "</span> &lt;&lt; evt-&gt;globalX();        <span class="comment">// globalX:  1739</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"globalY: "</span> &lt;&lt; evt-&gt;globalY();        <span class="comment">// globalY:  635</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"inverted: "</span> &lt;&lt; evt-&gt;inverted();      <span class="comment">// inverted:  false</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"phase: "</span> &lt;&lt; evt-&gt;phase();            <span class="comment">// phase:  Qt::NoScrollPhase</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"pixelDelta: "</span> &lt;&lt; evt-&gt;pixelDelta();  <span class="comment">// pixelDelta:  QPoint(0,0)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"pos: "</span> &lt;&lt; evt-&gt;pos();                <span class="comment">// pos:  QPoint(271,121)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"posF: "</span> &lt;&lt; evt-&gt;posF();              <span class="comment">// posF:  QPointF(271,121)</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"source: "</span> &lt;&lt; evt-&gt;source();          <span class="comment">// source:  Qt::MouseEventNotSynthesized</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"x: "</span> &lt;&lt; evt-&gt;x();                    <span class="comment">// x:  271</span></span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"y: "</span> &lt;&lt; evt-&gt;y();                    <span class="comment">// y:  121</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考<a href="https://doc.qt.io/qt-5.12/qwheelevent.html#angleDelta" target="_blank" rel="noopener">QWheelEvent Class | Qt GUI 5.12.10</a>，得知其中<code>angleDelta()</code>返回的是滚轮滚动的角度，往上滚为<code>+</code>，往下滚为<code>-</code>，一般为120，除以8得到滚动的角度为15度。（做了个标记数了一圈，确实是滚动24下回到原点）。</p>
<p>另外有用的两组函数是<code>globalX(), globalY()</code>和<code>x(), y()</code>。分别表示当前鼠标点位于屏幕和软件中的x、y坐标值，起始为0。</p>
<p>滚动缩放时需要针对鼠标中心计算缩放后的矩形坐标，思想比较简单，在代码中体现，完整代码如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">KvImage::wheelEvent</span><span class="params">(QWheelEvent* evt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 接收事件，不往下传递</span></span><br><span class="line">	evt-&gt;accept();</span><br><span class="line">	qDebug() &lt;&lt; <span class="string">"angleDelta: "</span> &lt;&lt; evt-&gt;angleDelta().y();  <span class="comment">// angleDelta:  QPoint(0,120)</span></span><br><span class="line">	QPointF pt = evt-&gt;posF();    <span class="comment">// 鼠标中心点</span></span><br><span class="line">	<span class="keyword">double</span> delta = <span class="number">0.1</span>;          <span class="comment">// 缩放系数</span></span><br><span class="line">	delta *= <span class="keyword">double</span>(evt-&gt;angleDelta().y()) / <span class="number">8</span> / <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// (x0-x1)/(x0-x2) = w1/w2 = 1/(1+delta)</span></span><br><span class="line">	<span class="keyword">int</span> x0 = pt.x(),</span><br><span class="line">		y0 = pt.y(),</span><br><span class="line">		x1 = <span class="keyword">this</span>-&gt;mRect.x,</span><br><span class="line">		y1 = <span class="keyword">this</span>-&gt;mRect.y;</span><br><span class="line">	<span class="keyword">this</span>-&gt;mRect.<span class="built_in">width</span> *= (<span class="number">1</span> + delta);</span><br><span class="line">	<span class="keyword">this</span>-&gt;mRect.<span class="built_in">height</span> *= (<span class="number">1</span> + delta);</span><br><span class="line">	<span class="keyword">this</span>-&gt;mRect.x = x0 + (x1 - x0) * (<span class="number">1</span> + delta);</span><br><span class="line">	<span class="keyword">this</span>-&gt;mRect.y = y0 + (y1 - y0) * (<span class="number">1</span> + delta);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">this</span>-&gt;showImage(<span class="keyword">this</span>-&gt;mImg, <span class="keyword">this</span>-&gt;mRect);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="添加文件输出日志"><a href="#添加文件输出日志" class="headerlink" title="添加文件输出日志"></a>添加文件输出日志</h1><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"KvImage.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtWidgets/QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QFile&gt;;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDateTime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> QT_VERSION &gt;= QT_VERSION_CHECK(5,0,0)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">customMessageHandler</span><span class="params">(QtMsgType type, <span class="keyword">const</span> QMessageLogContext&amp;, <span class="keyword">const</span> QString&amp; str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	QString txt = str;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">customMessageHandler</span><span class="params">(QtMsgType type, <span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">QString <span class="title">txt</span><span class="params">(msg)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">// 打开日志文件</span></span><br><span class="line">	<span class="function">QFile <span class="title">of</span><span class="params">(<span class="string">"KvImage.log"</span>)</span></span>;</span><br><span class="line">	of.<span class="built_in">open</span>(QIODevice::WriteOnly | QIODevice::Append);</span><br><span class="line">	<span class="function">QTextStream <span class="title">ts</span><span class="params">(&amp;of)</span></span>;</span><br><span class="line">	ts.setCodec(<span class="string">"UTF-8"</span>);  <span class="comment">// 处理中文乱码</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 输出字符串</span></span><br><span class="line">	QString typeStr;</span><br><span class="line">	<span class="keyword">switch</span> (type)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> QtDebugMsg:</span><br><span class="line">		typeStr = <span class="string">"Debug"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> QtWarningMsg:</span><br><span class="line">		typeStr = <span class="string">"Warning"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> QtCriticalMsg: <span class="comment">// QtSystemMsg</span></span><br><span class="line">		typeStr = <span class="string">"Critical"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> QtFatalMsg:</span><br><span class="line">		typeStr = <span class="string">"Fatal"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> QtInfoMsg:</span><br><span class="line">		typeStr = <span class="string">"Info"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	QString logStr = QString(<span class="string">"(%1) File:(%2) Line:(%3) - [%4] - %5\n"</span>)</span><br><span class="line">		.arg(QDateTime::currentDateTime().toString(<span class="string">"yyyy-MM-dd hh:mm:ss ddd"</span>))  <span class="comment">// 时间</span></span><br><span class="line">		.arg(__FILE__).arg(__LINE__)  <span class="comment">// 文件和行数</span></span><br><span class="line">		.arg(typeStr)  <span class="comment">// 日志类型</span></span><br><span class="line">		.arg(txt);  <span class="comment">// 消息内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 输出到控制台</span></span><br><span class="line">	OutputDebugString(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">wchar_t</span>*&gt;(logStr.utf16()));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 不输出debug到文件中</span></span><br><span class="line">	<span class="keyword">if</span> (type == QtDebugMsg)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 输出到文件</span></span><br><span class="line">	ts &lt;&lt; logStr;</span><br><span class="line">	of.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果是Fatal，显示对话框并退出</span></span><br><span class="line">	<span class="keyword">if</span> (type == QtFatalMsg)</span><br><span class="line">	&#123;</span><br><span class="line">		QMessageBox::warning(<span class="literal">nullptr</span>, <span class="string">"Warning"</span>, txt, QMessageBox::Button::Default, QMessageBox::Button::Cancel);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 控制调试信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> QT_VERSION &gt;= QT_VERSION_CHECK(5,0,0)</span></span><br><span class="line">	qInstallMessageHandler(customMessageHandler);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	qInstallMsgHandler(customMessageHandler);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">	</span><br><span class="line">	qInfo() &lt;&lt; <span class="string">"Start app"</span>;</span><br><span class="line">	KvImage w;</span><br><span class="line">	w.show();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> exitCode = a.exec();</span><br><span class="line">	qInfo() &lt;&lt; <span class="string">"Exit app with code: "</span> &lt;&lt; exitCode;</span><br><span class="line">	<span class="keyword">return</span> exitCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="解决重写消息控制后无法输出到控制台的问题"><a href="#解决重写消息控制后无法输出到控制台的问题" class="headerlink" title="解决重写消息控制后无法输出到控制台的问题"></a>解决重写消息控制后无法输出到控制台的问题</h2><p>重写消息控制使用<code>qInstallMessageHandler</code>实现，函数使用方法如上一小节所示。重写的目的在于将输入结果写到日志文件中，但是会覆盖掉原先的输出到控制台的功能。为了实现既能输出到日志文件，又能输出到控制台，需要进一步操作。</p>
<h3 id="输出到控制台的函数：OutputDebugString"><a href="#输出到控制台的函数：OutputDebugString" class="headerlink" title="输出到控制台的函数：OutputDebugString"></a>输出到控制台的函数：OutputDebugString</h3><p>输出到控制台需要用到包含在头文件<code>Windows.h</code>中的函数<code>OutputDebugString()</code>，该函数的输入类型为<code>LPCWSTR</code>，即<code>const WCHAR *</code>，而<code>WCHAR</code>是<code>wchar_t</code>的类型定义，意思是宽字符（wide char），表示16位的Unicode字符（16-bit UNICODE character）。所以只需要将函数输入设置为<code>const wchar_t *</code>即可实现控制台输出。</p>
<p>该函数用法类似于<code>printf</code>，区别在于：1. 使用<code>const wchar_t *</code>而不是<code>const char *</code>；2. 不支持模板字符串。</p>
<h3 id="直接输出字符串到控制台"><a href="#直接输出字符串到控制台" class="headerlink" title="直接输出字符串到控制台"></a>直接输出字符串到控制台</h3><p>即<code>const char *</code>（静态字符串）转<code>const wchar_t *</code>，只需要在字符串之前加一个L即可实现</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputDebugString(<span class="string">L"控制台输出"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="将const-char-输出到控制台"><a href="#将const-char-输出到控制台" class="headerlink" title="将const char *输出到控制台"></a>将const char *输出到控制台</h3><p>即<code>const char *</code>（变量）转<code>const wchar_t *</code>，<code>MultiByteToWideChar</code>包含在头文件<code>Windows.h</code>中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* cstr = <span class="string">"你好"</span>;</span><br><span class="line"><span class="keyword">int</span> strSize = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (cstr[strSize] != <span class="string">'\0'</span>) strSize++;</span><br><span class="line"><span class="keyword">wchar_t</span>* wString = <span class="keyword">new</span> <span class="keyword">wchar_t</span>[strSize];</span><br><span class="line">MultiByteToWideChar(CP_ACP, <span class="number">0</span>, cstr, <span class="number">-1</span>, wString, strSize);</span><br><span class="line">OutputDebugString(wString);</span><br><span class="line"><span class="keyword">delete</span>[] wString;</span><br></pre></td></tr></table></figure>
<h3 id="将std-string输出到控制台"><a href="#将std-string输出到控制台" class="headerlink" title="将std::string输出到控制台"></a>将std::string输出到控制台</h3><p>方法类似于将<code>const char *</code>（变量）输出到控制台，<code>MultiByteToWideChar</code>包含在头文件<code>Windows.h</code>中。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> stdStr = <span class="string">"你好"</span>;</span><br><span class="line"><span class="keyword">int</span> strSize = <span class="keyword">int</span>(stdStr.length());</span><br><span class="line"><span class="keyword">wchar_t</span>* wString = <span class="keyword">new</span> <span class="keyword">wchar_t</span>[strSize];</span><br><span class="line">MultiByteToWideChar(CP_ACP, <span class="number">0</span>, stdStr.c_str(), <span class="number">-1</span>, wString, strSize);</span><br><span class="line">OutputDebugString(wString);</span><br><span class="line"><span class="keyword">delete</span>[] wString;</span><br></pre></td></tr></table></figure>
<h3 id="将QString的结果输出到控制台"><a href="#将QString的结果输出到控制台" class="headerlink" title="将QString的结果输出到控制台"></a>将QString的结果输出到控制台</h3><p>即<code>QString</code>转<code>const wchar_t *</code>，通过使用<code>reinterpret_cast</code>来实现。<code>reinterpret_cast</code>用来处理无关类型之间的转换；它会产生一个新的值，这个值会有与原始参数（expressoin）有完全相同的<strong>比特位</strong>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OutputDebugString(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> <span class="keyword">wchar_t</span>*&gt;(logStr.utf16()));  <span class="comment">// type of logStr is QString</span></span><br></pre></td></tr></table></figure>
<h1 id="避免中文乱码"><a href="#避免中文乱码" class="headerlink" title="避免中文乱码"></a>避免中文乱码</h1><p>由于VS创建的.cpp和.h文件默认通过GBK编码，使用<code>QString(&quot;中文&quot;)</code>构造字符串时，会出现乱码。这里的引号的内容作为字符串，对应的数据类型为<code>const char *</code>，而构造函数<code>QString(const char *)</code>默认是以UTF-8的编码解析字符串常量，因此当文件的编码格式不是UTF-8时，通过<code>QString(&quot;&quot;)</code>创建字符串时，会导致中文乱码。因此，当引号中有中文字符时，创建QString字符串应该使用其自带的静态方法。</p>
<p><code>std::string</code>解析静态字符串时默认使用GBK，因此不会出现中文乱码的问题，使用其作为跳板转成<code>QString</code>也是一种手段。下面介绍<code>const char *</code>，<code>std::string</code>与<code>QString</code>之间相互转换的方法。</p>
<h2 id="const-char-转QString"><a href="#const-char-转QString" class="headerlink" title="const char *转QString"></a>const char *转QString</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QString str = QString::fromLocal8Bit(<span class="string">"中文字符串"</span>);</span><br><span class="line"></span><br><span class="line">QString str = QString::fromLocal8Bit(<span class="string">"打开图像 (%1)"</span>).arg(fileName);  <span class="comment">// 使用模板插值</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> stdStr = <span class="string">"打开图像 (%1)"</span>;</span><br><span class="line">QString str = QString::fromLocal8Bit(stdStr.c_str()).arg(fileName);</span><br></pre></td></tr></table></figure>
<h2 id="QString转const-char"><a href="#QString转const-char" class="headerlink" title="QString转const char *"></a>QString转const char *</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里纯属脱裤子放屁</span></span><br><span class="line">QString qStr = QString::fromLocal8Bit(<span class="string">"你好啊"</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* c_str = qStr.toLocal8Bit();</span><br></pre></td></tr></table></figure>
<h2 id="QString转std-string"><a href="#QString转std-string" class="headerlink" title="QString转std::string"></a>QString转std::string</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QString str = QString::fromLocal8Bit(<span class="string">"中文字符串"</span>);</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> stdStr = str.toLocal8Bit().toStdString();</span><br></pre></td></tr></table></figure>
<h2 id="std-string转QString"><a href="#std-string转QString" class="headerlink" title="std::string转QString"></a>std::string转QString</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> stdStr = <span class="string">"你好"</span>;</span><br><span class="line">QString str = QString::fromStdString(stdStr);</span><br></pre></td></tr></table></figure>
<hr>
<p>至此，从0开始开发的Windows平台下使用VS的基于Qt和OpenCV的图像浏览软件开发完毕。细节非常多，关乎Qt开发、OpenCV开发和VS配置，还包括了一些数学运算思维，有的没有列出公式解释，但都包含在代码中，且进行了思路描述，用作以后的参考。</p>
<p>不过当软件开发完毕运行时，还是发现了一些值得优化的地方：</p>
<ol>
<li>卡顿。当软件界面较大时，会出现明显的卡顿现象，初步分析是由于在一整张窗口大小的位图上嵌入像素导致的。考虑使用Qt自带的嵌入像素操作，不需要生成窗口大小的位图，会产生大量无用的像素；</li>
<li>图像放大到很大时，程序崩溃。需要对图像缩放大小进行一定的约束，在缩放到某一阈值的时候，更换尺寸调整方案，停止使用OpenCV的resize方法；可以考虑在缩放到像素级别时，改成像素值渲染，显示每一个像素的正方格，附上亮度值；</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"><i class="fa fa-tag"></i> C++</a>
              <a href="/tags/Qt/" rel="tag"><i class="fa fa-tag"></i> Qt</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/21/PyInstaller%E4%BD%BF%E7%94%A8%E6%89%8B%E8%AE%B0/" rel="prev" title="PyInstaller使用手记">
      <i class="fa fa-chevron-left"></i> PyInstaller使用手记
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/04/12/%E4%BB%8E1%E5%88%B02-%E5%9B%BE%E5%83%8F%E6%B5%8F%E8%A7%88%E8%BD%AF%E4%BB%B6%E7%9A%84%E4%BC%98%E5%8C%96%E4%B8%8E%E6%94%B9%E8%BF%9B/" rel="next" title="从1到2：图像浏览软件的优化与改进">
      从1到2：图像浏览软件的优化与改进 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安装"><span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Qt的安装"><span class="nav-text">Qt的安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VS插件的安装"><span class="nav-text">VS插件的安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hello-World"><span class="nav-text">Hello World</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#问题1-没有与指定类型匹配的重载函数"><span class="nav-text">问题1 没有与指定类型匹配的重载函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题2-ERROR-running-qmake"><span class="nav-text">问题2 ERROR running qmake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#彻底解决问题1与问题2"><span class="nav-text">彻底解决问题1与问题2</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加基础功能示例：打开一幅图像"><span class="nav-text">添加基础功能示例：打开一幅图像</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#布局"><span class="nav-text">布局</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打开图像文件对话框"><span class="nav-text">打开图像文件对话框</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用OpenCV读取图像"><span class="nav-text">使用OpenCV读取图像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenCV与QImage和QPixmap的相互转化"><span class="nav-text">OpenCV与QImage和QPixmap的相互转化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#在QLabel中显示图像QPixmap"><span class="nav-text">在QLabel中显示图像QPixmap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本设置方法"><span class="nav-text">基本设置方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指定显示区域尺寸的位图"><span class="nav-text">指定显示区域尺寸的位图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#★★★同时指定显示区域尺寸和图像矩形的位图"><span class="nav-text">★★★同时指定显示区域尺寸和图像矩形的位图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#showImage图像显示接口函数"><span class="nav-text">showImage图像显示接口函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#打开图像的响应函数"><span class="nav-text">打开图像的响应函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QLabel的大小及图像自适应"><span class="nav-text">QLabel的大小及图像自适应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#图像缩放和拖动"><span class="nav-text">图像缩放和拖动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#图像矩形的概念"><span class="nav-text">图像矩形的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加入图像矩形后的程序优化"><span class="nav-text">加入图像矩形后的程序优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拖动图像"><span class="nav-text">拖动图像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缩放图像"><span class="nav-text">缩放图像</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#添加文件输出日志"><span class="nav-text">添加文件输出日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#完整代码"><span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决重写消息控制后无法输出到控制台的问题"><span class="nav-text">解决重写消息控制后无法输出到控制台的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#输出到控制台的函数：OutputDebugString"><span class="nav-text">输出到控制台的函数：OutputDebugString</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#直接输出字符串到控制台"><span class="nav-text">直接输出字符串到控制台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将const-char-输出到控制台"><span class="nav-text">将const char *输出到控制台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将std-string输出到控制台"><span class="nav-text">将std::string输出到控制台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将QString的结果输出到控制台"><span class="nav-text">将QString的结果输出到控制台</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#避免中文乱码"><span class="nav-text">避免中文乱码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#const-char-转QString"><span class="nav-text">const char *转QString</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QString转const-char"><span class="nav-text">QString转const char *</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QString转std-string"><span class="nav-text">QString转std::string</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#std-string转QString"><span class="nav-text">std::string转QString</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="林杉"
      src="/images/blog/avatar_136x136.png">
  <p class="site-author-name" itemprop="name">林杉</p>
  <div class="site-description" itemprop="description">开发记录 & 思考笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">林杉</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">285k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:19</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '77edc458d1e975c91584',
      clientSecret: 'd066ea784ad9a8840650ce87154372d890562ecc',
      repo        : 'whuls.github.io',
      owner       : 'WHULS',
      admin       : ['WHULS'],
      id          : 'd0c34938aeb9d6f3d77d2ebb84fcef67',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
